# PM2 – Die idiotensichere Dokumentation

> PM2 ist ein **Process Manager** für Node.js-Anwendungen. Er sorgt dafür, dass deine App im Hintergrund läuft, automatisch neustartet bei Crashes und nach Server-Reboots wieder hochfährt.

---

## Wichtige Begriffe erklärt

| Begriff | Bedeutung |
|---------|-----------|
| **Process Manager** | Ein Programm, das andere Programme überwacht und am Leben hält |
| **Daemon** | Ein Hintergrundprozess, der ohne Terminal läuft |
| **Cluster Mode** | Mehrere Instanzen deiner App auf verschiedenen CPU-Kernen |
| **Fork Mode** | Eine einzelne Instanz deiner App (Standard) |
| **ecosystem.config.js** | Die Konfigurationsdatei für PM2 |
| **PM2 ID** | Eindeutige Nummer für jeden gestarteten Prozess |
| **PM2 Name** | Der Name, den du deiner App gibst |

---

## Installation

```bash
# Global installieren (einmalig auf dem Server)
npm install -g pm2

# Prüfen ob es funktioniert hat
pm2 --version
```

---

## Die wichtigsten PM2 Befehle

### App starten

```bash
# Einfachster Weg
pm2 start app.js

# Mit eigenem Namen
pm2 start app.js --name "meine-app"

# Next.js App starten (nach npm run build)
pm2 start npm --name "nextjs-app" -- start
```

### Apps verwalten

```bash
# Alle laufenden Apps anzeigen
pm2 list

# Detaillierte Infos zu einer App
pm2 show meine-app

# Logs anzeigen (live)
pm2 logs

# Logs einer bestimmten App
pm2 logs meine-app

# App neustarten
pm2 restart meine-app

# App stoppen
pm2 stop meine-app

# App komplett entfernen
pm2 delete meine-app

# ALLE Apps stoppen
pm2 stop all

# ALLE Apps löschen
pm2 delete all
```

### Autostart nach Server-Reboot

```bash
# Startup-Script generieren (einmalig ausführen!)
pm2 startup

# Aktuelle App-Liste speichern
pm2 save
```

> **Wichtig:** Nach `pm2 startup` zeigt PM2 dir einen Befehl an, den du mit sudo ausführen musst!

---

## Next.js mit PM2 betreiben

### Schritt für Schritt

```bash
# 1. In dein Projektverzeichnis wechseln
cd /var/www/meine-nextjs-app

# 2. Dependencies installieren
npm install

# 3. Production Build erstellen
npm run build

# 4. Mit PM2 starten
pm2 start npm --name "meine-nextjs-app" -- start
```

---

## Port-Konfiguration

### Das Problem verstehen

- Next.js läuft standardmäßig auf **Port 3000**
- Wenn du mehrere Apps hast, braucht jede einen eigenen Port
- Ports unter 1024 brauchen Root-Rechte (z.B. Port 80)

### Port ändern

```bash
# Direkt beim Start
pm2 start npm --name "app1" -- start -- -p 3001
pm2 start npm --name "app2" -- start -- -p 3002

# Oder via Umgebungsvariable
PORT=3001 pm2 start npm --name "app1" -- start
```

### Port in Next.js config

In deiner `package.json`:

```json
{
  "scripts": {
    "start": "next start -p 3001"
  }
}
```

---

## ecosystem.config.js – Die Profi-Lösung

Erstelle diese Datei im Projektroot:

```javascript
// ecosystem.config.js
module.exports = {
  apps: [
    {
      // === BASICS ===
      name: 'meine-nextjs-app',        // Name in PM2
      cwd: '/var/www/meine-app',       // Arbeitsverzeichnis
      script: 'npm',                   // Was ausgeführt wird
      args: 'start',                   // Argumente für script
      
      // === UMGEBUNGSVARIABLEN ===
      env: {
        NODE_ENV: 'production',
        PORT: 3001,
      },
      
      // === PERFORMANCE ===
      instances: 1,                    // Anzahl Instanzen (oder 'max')
      exec_mode: 'fork',               // 'fork' oder 'cluster'
      
      // === NEUSTART-VERHALTEN ===
      watch: false,                    // Bei Dateiänderung neustarten?
      max_memory_restart: '500M',      // Neustart bei Speicherüberschreitung
      restart_delay: 3000,             // Wartezeit vor Neustart (ms)
      max_restarts: 10,                // Max Neustarts in Folge
      
      // === LOGS ===
      error_file: './logs/error.log',
      out_file: './logs/output.log',
      merge_logs: true,
      log_date_format: 'YYYY-MM-DD HH:mm:ss',
    }
  ]
};
```

### Mit ecosystem.config.js starten

```bash
# Alle Apps aus der Config starten
pm2 start ecosystem.config.js

# Nur eine bestimmte App
pm2 start ecosystem.config.js --only meine-nextjs-app

# Neustarten
pm2 restart ecosystem.config.js
```

---

## Mehrere Next.js Apps auf einem Server

```javascript
// ecosystem.config.js
module.exports = {
  apps: [
    {
      name: 'frontend',
      cwd: '/var/www/frontend',
      script: 'npm',
      args: 'start',
      env: {
        PORT: 3000,
        NODE_ENV: 'production',
      }
    },
    {
      name: 'backend-api',
      cwd: '/var/www/backend',
      script: 'npm',
      args: 'start',
      env: {
        PORT: 3001,
        NODE_ENV: 'production',
      }
    },
    {
      name: 'admin-panel',
      cwd: '/var/www/admin',
      script: 'npm',
      args: 'start',
      env: {
        PORT: 3002,
        NODE_ENV: 'production',
      }
    }
  ]
};
```

---

## Nginx als Reverse Proxy (Bonus)

Um deine Apps über Port 80/443 erreichbar zu machen:

```nginx
# /etc/nginx/sites-available/meine-app
server {
    listen 80;
    server_name meine-domain.de;

    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

---

## Troubleshooting

### App startet nicht?

```bash
# Logs checken!
pm2 logs meine-app --lines 100

# Detaillierte Infos
pm2 show meine-app
```

### Port schon belegt?

```bash
# Welcher Prozess nutzt den Port?
lsof -i :3000

# oder
netstat -tulpn | grep 3000
```

### PM2 komplett zurücksetzen

```bash
pm2 kill          # Daemon stoppen
pm2 delete all    # Alle Apps löschen
pm2 flush         # Logs löschen
```

### Nach Code-Änderungen

```bash
# Neuen Build erstellen
npm run build

# App neustarten
pm2 restart meine-app
```

---

## Cheat Sheet

| Was du willst | Befehl |
|---------------|--------|
| App starten | `pm2 start npm --name "app" -- start` |
| Status sehen | `pm2 list` |
| Logs live | `pm2 logs` |
| Neustarten | `pm2 restart app` |
| Stoppen | `pm2 stop app` |
| Löschen | `pm2 delete app` |
| Autostart einrichten | `pm2 startup` + `pm2 save` |
| Mit Config starten | `pm2 start ecosystem.config.js` |
| Monitoring | `pm2 monit` |

---

## Wichtige Dateipfade

| Was | Wo |
|-----|-----|
| PM2 Logs | `~/.pm2/logs/` |
| PM2 PIDs | `~/.pm2/pids/` |
| Gespeicherte Prozesse | `~/.pm2/dump.pm2` |
| ecosystem.config.js | Im Projektroot |